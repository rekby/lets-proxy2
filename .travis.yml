language: go

addons:
  apt:
    packages:
      - dos2unix

go:
  - "1.12.4"

env:
  - GO111MODULE=on GOFLAGS=-mod=vendor

services:
  - docker

install:
  - "true" # bash tests/prepare.sh

script:
  - "true" # go test -v -covermode=count -coverprofile=coverage.out ./...

after_script:
  # Install and upload test coverage must not failure for test build
  - go get -mod= golang.org/x/tools/cmd/cover
  - go get -mod= github.com/mattn/goveralls
  - goveralls -coverprofile=coverage.out -service=travis-ci -repotoken $COVERALLS_TOKEN

before_deploy:
  - go get -mod= github.com/mitchellh/gox
  - mkdir -p output
  - gox --ldflags "-X \"main.VERSION=$TRAVIS_TAG commit $TRAVIS_COMMIT\"" --output="output/lets-proxy_{{.OS}}_{{.Arch}}" -verbose --rebuild
  - bash tests/make_archives.sh

deploy:
  skip_cleanup: true
#  tags: true
  provider: releases
  on:
    repo: rekby/lets-proxy2
#    tags: true
  api_key: $GITHUB_TOKEN
  file_glob: true
  file: binaries/*

